var gm = require('gm');

function move(options , callback){
	var destination = options.destination;
	var files = options.context.files;
	create(destination);
  	console.log(files);
	 $.each(files , function(i,v){
	            fs.rename(v , destination + "/" + path.basename(v) , function(){});
	 });
}

function getFiles(directory , fileFormat , callback){
	glob(directory+"/"+ fileFormat, undefined, function (er, files) {
       callback(files);
    });
}

function rotate(options , callback){
	var images = options.context.files;
	var i = 0;
	$.each(images , function(i,f){
		gm(f)
		.rotate('green', -90)
		.autoOrient()
		.write(f, function (err) {
		  	i++;
		  	if( i == images.length ) callback(images);
		});
	});
}

function resize(options , callback){
	var images = options.context.files;
	var w = options.width;
	var h = options.height;
	var i = 0;
	$.each(images , function(i,f){
		gm(f)
		.resize(w,h)
		.autoOrient()
		.write(f, function (err) {
		  	i++;
		  	if( i == images.length ) callback(images);
		});
	});
}

function copy(options , callback){
	var destination = options.destination;
	var files = options.context.files;
	create(destination);
	var arr = [];
	$.each(files , function(i , file){
		var dest = destination + path.basename(file);
		fs.createReadStream(file)
		.pipe(fs.createWriteStream(dest)).on('finish', function (err) { 
			arr.push(dest);
			if(arr.length == files.length) callback(arr);
		 });
		
	});

}

function create(dir){
    if (!fs.existsSync(dir)){
        fs.mkdirSync(dir);
  	}
}

module.exports = {
	move : move ,
	getFiles : getFiles,
	rotate : rotate,
	copy : copy,
	resize : resize
}